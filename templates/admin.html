<!DOCTYPE html>
<html>
<head>
    <title>Admin Chat Panel</title>
    <style>
        .chat-container {
            display: flex;
            height: 100vh;
        }
        .users-list {
            width: 250px;
            border-right: 1px solid #ccc;
            padding: 10px;
        }
        .chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .message {
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
        }
        .admin-message {
            background: #e3f2fd;
            margin-left: 20%;
        }
        .user-message {
            background: #f5f5f5;
            margin-right: 20%;
        }
        .telegram-user {
            background: #dcf8c6;
        }
        .platform-badge {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .telegram-badge {
            background: #0088cc;
            color: white;
        }
        .web-badge {
            background: #4caf50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="users-list" id="usersList">
            <h3>Active Users</h3>
            <!-- Users will be listed here -->
        </div>
        <div class="chat-window">
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type a message..." style="width: 70%;">
                <select id="messageType">
                    <option value="web">Web User</option>
                    <option value="telegram">Telegram User</option>
                </select>
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let selectedUserId = null;
        const ws = new WebSocket('ws://localhost:8000/ws/admin');

        // Periodically update the list of active users
        function updateUsersList() {
            fetch('/active-users')
                .then(response => response.json())
                .then(data => {
                    const usersList = document.getElementById('usersList');
                    const users = data.users;

                    // Save the selected user
                    const selectedUserElement = usersList.querySelector('.selected');
                    const selectedUserId = selectedUserElement ? selectedUserElement.getAttribute('data-user-id') : null;

                    // Update the list of users
                    usersList.innerHTML = '<h3>Active Users</h3>';
                    users.forEach(userId => {
                        const userDiv = document.createElement('div');
                        userDiv.setAttribute('data-user-id', userId);
                        userDiv.onclick = () => selectUser(userId);

                        // Add badge for Telegram users
                        const isTelegram = userId.startsWith('telegram_');
                        userDiv.innerHTML = `
                            ${userId}
                            <span class="platform-badge ${isTelegram ? 'telegram-badge' : 'web-badge'}">
                                ${isTelegram ? 'Telegram' : 'Web'}
                            </span>
                        `;

                        if (userId === selectedUserId) {
                            userDiv.classList.add('selected');
                        }

                        usersList.appendChild(userDiv);
                    });
                });
        }

        setInterval(updateUsersList, 5000);
        updateUsersList(); // Initial update

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            addMessage(data);
        };

        function addMessage(data) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            // Add appropriate classes based on sender
            if (data.sender === 'admin') {
                messageDiv.classList.add('admin-message');
            } else if (data.sender.startsWith('telegram_user_')) {
                messageDiv.classList.add('user-message', 'telegram-user');
            } else {
                messageDiv.classList.add('user-message');
            }

            // Format timestamp
            const timestamp = new Date(data.timestamp).toLocaleTimeString();

            // Create message content
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>${data.sender}</strong>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-content">${data.message}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function selectUser(userId) {
            selectedUserId = userId;

            // Update UI to show selected user
            document.querySelectorAll('#usersList div').forEach(div => {
                div.classList.remove('selected');
                if (div.getAttribute('data-user-id') === userId) {
                    div.classList.add('selected');
                }
            });

            // Load chat history
            fetch(`/messages/${userId}`)
                .then(response => response.json())
                .then(data => {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    data.messages.forEach(addMessage);
                });

            // Update message type selector based on user type
            const messageType = document.getElementById('messageType');
            messageType.value = userId.startsWith('telegram_') ? 'telegram' : 'web';
        }

        function sendMessage() {
            if (!selectedUserId) {
                alert('Please select a user first');
                return;
            }

            const messageInput = document.getElementById('messageInput');
            const messageType = document.getElementById('messageType').value;
            const message = messageInput.value.trim();

            if (message) {
                ws.send(JSON.stringify({
                    user_id: selectedUserId,
                    message: message,
                    type: messageType
                }));
                messageInput.value = '';
            }
        }

        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
